<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HCTM Dashboard V4 - Paparan Kontrak (Modified)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
// --- MAPPING GENERATED AUTOMATICALLY FROM CSV HEADERS ---
const fieldMap = {"kod_item": "KOD ITEM", "tajuk": "TAJUK", "nilai_rm": "NILAI ", "no_kontrak": "NO KONTRAK", "jenis": "JENIS PEROLEHAN", "perolehan": "JENIS PEROLEHAN", "tarikh_mula": "MULA KONTRAK", "tarikh_tamat": "TARIKH TAMAT KONTRAK", "status": "STATUS", "tarikh_iklan": "IKLAN", "mesyuarat_teknikal": "MESYUARAT TEKNIKAL", "hantar_laporan_teknikal": "HANTAR LAPORAN TEKNIKAL KE PEROLEHAN"};

// Helper: safely get value from row using mapping
function getField(row, key){
  const h = fieldMap[key];
  return h? (row[h] || '') : '';
}

// Format date if present
function formatDateString(s){ if(!s) return ''; try{ const d=new Date(s); if(isNaN(d)) return s; return d.toISOString().slice(0,10);}catch(e){return s} }

// Override renderTable to use mapped fields
function renderTable(rows){
  const tb=document.getElementById("tableBody"); tb.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="p-2">${{getField(r,'kod_item')}}</td>
    <td class="p-2">${{getField(r,'tajuk')}}</td>
    <td class="p-2">${{formatRM(getField(r,'nilai_rm'))}}</td>
    <td class="p-2">${{getField(r,'no_kontrak')}}</td>
    <td class="p-2">${{getField(r,'jenis')}}</td>
    <td class="p-2">${{getField(r,'perolehan')}}</td>
    <td class="p-2">${{formatDateString(getField(r,'tarikh_mula'))}}</td>
    <td class="p-2">${{formatDateString(getField(r,'tarikh_tamat'))}}</td>
    <td class="p-2">${{getField(r,'status')}}</td>
    <td class="p-2">${{formatDateString(getField(r,'tarikh_iklan'))}}</td>
    <td class="p-2">${{getField(r,'mesyuarat_teknikal')}}</td>
    <td class="p-2">${{getField(r,'hantar_laporan_teknikal')}}</td>`;
    tb.appendChild(tr);
  });
}

// Add simple helper to count contracts that are tamat/6bulan/1tahun - this is used by a new scroll-down small summary section
function kontrakStatusCounts(rows){
  const now = new Date();
  const counts = {{ tamat:0, '6bulan':0, '1tahun':0 }};
  rows.forEach(r=>{
    const t = new Date(getField(r,'tarikh_tamat'));
    if(!isNaN(t)){
      if(t < now) counts.tamat += 1;
      const in6 = new Date(); in6.setMonth(in6.getMonth()+6);
      if(t >= now && t <= in6) counts['6bulan'] += 1;
      const in1 = new Date(); in1.setFullYear(in1.getFullYear()+1);
      if(t >= now && t <= in1) counts['1tahun'] += 1;
    }
  });
  return counts;
}

// We'll call kontrakStatusCounts in render() and show simple summary below the table.

</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(180deg,#0f172a,#07103a); color:#e6eef8; }
    .card { background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); }
    .muted { color:#9fb0d6; }
    table th, table td { border-color: rgba(255,255,255,0.05); }
    .scrollbox { max-height:450px; overflow:auto; }
  </style>
</head>
<body class="p-6 font-sans">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-2xl font-semibold mb-2">Dashboard Perolehan HCTM (V4)</h1>
    <p class="muted mb-4">Tambahan: Penapis dropdown “Paparan Kontrak” (Aktif, 6 Bulan Tamat, Tamat Tahun Semasa)</p>

    <!-- Filter Section -->
    <section class="grid md:grid-cols-6 gap-3 card p-4 rounded-lg mb-5">
      <div>
        <label class="block text-sm muted">Tahun</label>
        <select id="filterYear" class="mt-1 w-full bg-transparent border rounded p-2"></select>
      </div>
      <div>
        <label class="block text-sm muted">Jenis</label>
        <select id="filterJenis" class="mt-1 w-full bg-transparent border rounded p-2">
          <option value="all">Semua</option>
          <option value="TENDER">Tender</option>
          <option value="SEBUT HARGA">Sebut Harga</option>
        </select>
      </div>
      <div>
        <label class="block text-sm muted">Status</label>
        <select id="filterStatus" class="mt-1 w-full bg-transparent border rounded p-2"></select>
      </div>
      <div>
        <label class="block text-sm muted">Paparan Kontrak</label>
        <select id="filterContract" class="mt-1 w-full bg-transparent border rounded p-2">
          <option value="all">Semua</option>
          <option value="aktif">Aktif</option>
          <option value="6bulan">6 Bulan Tamat</option>
          <option value="tahuns">Tamat Tahun Semasa</option>
        </select>
      </div>
      <div class="md:col-span-2 text-right flex items-end justify-end">
        <button id="btnReset" class="px-3 py-2 bg-sky-600 rounded text-white">Reset</button>
      </div>
    </section>

    <!-- Cards -->
    <section class="grid md:grid-cols-3 gap-4 mb-5">
      <div class="card p-4 rounded-lg">
        <h3 class="font-semibold mb-1">Jumlah Kontrak (RM)</h3>
        <div id="cardTotalRM" class="text-2xl font-bold">-</div>
      </div>
      <div class="card p-4 rounded-lg">
        <h3 class="font-semibold mb-1">Bilangan Perolehan</h3>
        <div id="cardCount" class="text-2xl font-bold">-</div>
      </div>
      <div class="card p-4 rounded-lg">
        <h3 class="font-semibold mb-1">Tahun Dipilih</h3>
        <div id="cardYear" class="text-2xl font-bold">-</div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid md:grid-cols-2 gap-4 mb-5">
      <div class="card p-4 rounded-lg"><canvas id="chartJenis"></canvas></div>
      <div class="card p-4 rounded-lg"><canvas id="chartTrend"></canvas></div>
    </section>

    <!-- Table -->
    <section class="card p-4 rounded-lg">
      <h3 class="font-semibold mb-2">Senarai Perolehan</h3>
      <div class="scrollbox">
        <table class="min-w-full text-sm">
          <thead>

              <tr class="text-left border-b border-slate-700">
                <th class="p-2">KOD ITEM</th>
                <th class="p-2">TAJUK</th>
                <th class="p-2">NILAI (RM)</th>
                <th class="p-2">NO KONTRAK</th>
                <th class="p-2">JENIS</th>
                <th class="p-2">PEROLEHAN</th>
                <th class="p-2">TARIKH MULA KONTRAK</th>
                <th class="p-2">TARIKH TAMAT KONTRAK</th>
                <th class="p-2">STATUS</th>
                <th class="p-2">TARIKH IKLAN</th>
                <th class="p-2">MESYUARAT TEKNIKAL</th>
                <th class="p-2">HANTAR LAPORAN TEKNIKAL KE PEROLEHAN</th>
              </tr>

</thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

    <footer class="mt-6 muted text-sm text-center">Versi V4 • Tambahan dropdown “Paparan Kontrak”</footer>
  </div>

<script>
async function loadData(){ const r = await fetch("data.json"); return r.json(); }

function uniq(a){ return [...new Set(a.filter(x=>x))]; }
function formatRM(v){ return Number(v||0).toLocaleString(); }

function parseDate(v){ return v? new Date(v): null; }

function isAktif(r){ return r.tarikh_tamat && r.tarikh_tamat > new Date(); }
function is6Bulan(r){ const now=new Date(); const next6=new Date(); next6.setMonth(next6.getMonth()+6); return r.tarikh_tamat && r.tarikh_tamat>=now && r.tarikh_tamat<=next6; }
function isTahunSemasa(r){ const now=new Date(); return r.tarikh_tamat && r.tarikh_tamat<now && r.tarikh_tamat.getFullYear()===now.getFullYear(); }

function filterData(rows){
  const fy = document.getElementById('filterYear').value;
  const fj = document.getElementById('filterJenis').value;
  const fs = document.getElementById('filterStatus').value;
  const fc = document.getElementById('filterContract').value;
  let d = [...rows];
  if(fy!=='all') d = d.filter(r=>String(r.tahun)===String(fy));
  if(fj!=='all') d = d.filter(r=>r.jenis===fj);
  if(fs!=='all') d = d.filter(r=>r.status===fs);
  if(fc==='aktif') d = d.filter(isAktif);
  if(fc==='6bulan') d = d.filter(is6Bulan);
  if(fc==='tahuns') d = d.filter(isTahunSemasa);
  return d;
}

function renderTable(rows){
  const tb=document.getElementById("tableBody"); tb.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="p-2">${r.tahun||''}</td>
    <td class="p-2">${r.pic||''}</td>
    <td class="p-2">${r.jenis||''}</td>
    <td class="p-2">${r.status||''}</td>
    <td class="p-2">${r.syarikat||''}</td>
    <td class="p-2">${formatRM(r.nilai_kontrak_rm)}</td>
    <td class="p-2">${r.tarikh_mula?r.tarikh_mula.toISOString().slice(0,10):''}</td>
    <td class="p-2">${r.tarikh_tamat?r.tarikh_tamat.toISOString().slice(0,10):''}</td>
    <td class="p-2">${r.no_kontrak||''}</td>`;
    tb.appendChild(tr);
  });
}

function updateCards(rows){
  document.getElementById("cardCount").textContent = rows.length;
  document.getElementById("cardTotalRM").textContent = formatRM(rows.reduce((a,b)=>a+Number(b.nilai_kontrak_rm||0),0));
  const year = document.getElementById("filterYear").value;
  document.getElementById("cardYear").textContent = (year==='all')?'-':year;
}

function drawCharts(rows){
  const jenisCount={}; rows.forEach(r=>{ jenisCount[r.jenis]=(jenisCount[r.jenis]||0)+1; });
  const trendCount={}; rows.forEach(r=>{ trendCount[r.tahun]=(trendCount[r.tahun]||0)+1; });
  const ctx1=document.getElementById("chartJenis").getContext("2d");
  const ctx2=document.getElementById("chartTrend").getContext("2d");
  new Chart(ctx1,{type:'bar',data:{labels:Object.keys(jenisCount),datasets:[{data:Object.values(jenisCount)}]}});
  new Chart(ctx2,{type:'line',data:{labels:Object.keys(trendCount),datasets:[{data:Object.values(trendCount)}]}});
}

async function main(){
  const raw=await loadData();
  const rows=raw.map(r=>({
    ...r,
    tarikh_mula:parseDate(r.tarikh_mula),
    tarikh_tamat:parseDate(r.tarikh_tamat)
  }));
  const years=uniq(rows.map(r=>r.tahun)).sort();
  const statuses=uniq(rows.map(r=>r.status)).sort();
  document.getElementById("filterYear").innerHTML='<option value="all">Semua</option>'+years.map(y=>`<option>${y}</option>`).join('');
  document.getElementById("filterStatus").innerHTML='<option value="all">Semua</option>'+statuses.map(s=>`<option>${s}</option>`).join('');
  function render(){
    const f=filterData(rows);
    updateCards(f);
    renderTable(f);
    drawCharts(f);
  }
  document.querySelectorAll("select").forEach(s=>s.addEventListener("change",render));
  document.getElementById("btnReset").addEventListener("click",()=>{document.querySelectorAll("select").forEach(s=>s.value="all");render();});
  render();
}
main();
</script>
</body>
</html>
